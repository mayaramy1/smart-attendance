<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Attendance Cloud System</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root { 
            --primary-red: #ff0000; 
            --dark-bg: #0b0b0b; 
            --card-bg: #161616; 
            --glow: 0 0 15px rgba(255, 0, 0, 0.6); 
        }

        body { margin: 0; background-color: var(--dark-bg); color: white; font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { width: 95%; max-width: 900px; background: var(--card-bg); border: 2px solid var(--primary-red); box-shadow: var(--glow); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; margin: 10px; }

        /* --- Login Screen --- */
        #loginPage { display: flex; flex-wrap: wrap; width: 100%; min-height: 500px; }
        .login-left { flex: 1; min-width: 300px; padding: 40px; display: flex; flex-direction: column; justify-content: center; }
        .login-right { flex: 1; min-width: 300px; background: linear-gradient(45deg, #000, var(--primary-red)); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 40px; clip-path: polygon(15% 0%, 100% 0%, 100% 100%, 0% 100%); }
        .inputbox { position: relative; margin-bottom: 25px; border-bottom: 2px solid white; }
        .inputbox input { width: 100%; background: transparent; border: none; outline: none; color: white; padding: 12px 5px; font-size: 16px; }
        .btn-glow { background: transparent; border: 2px solid var(--primary-red); color: white; padding: 12px; border-radius: 30px; cursor: pointer; font-weight: bold; transition: 0.3s; box-shadow: var(--glow); text-transform: uppercase; }
        .btn-glow:hover { background: var(--primary-red); box-shadow: 0 0 25px var(--primary-red); }

        /* --- Dashboard --- */
        #mainPage { display: none; padding: 15px; flex-direction: column; }
        .header-nav { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary-red); padding-bottom: 10px; margin-bottom: 15px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .card { background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; border: 1px solid rgba(255, 0, 0, 0.2); }
        
        .add-student-container { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        .manual-input { flex: 2; min-width: 200px; background: #000; color: white; border: 1px solid var(--primary-red); padding: 10px; border-radius: 5px; }
        .btn-add { flex: 1; min-width: 100px; background: transparent; border: 2px solid var(--primary-red); color: white; cursor: pointer; font-weight: bold; border-radius: 5px; transition: 0.3s; }
        .btn-add:hover { background: var(--primary-red); }

        .table-scroll { width: 100%; overflow-x: auto; margin-top: 15px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; text-align: left; }
        th { background: #800000; padding: 12px; }
        td { padding: 10px; border-bottom: 1px solid #333; }

        .status-absent { color: #ff4d4d; font-weight: bold; }
        .status-present { color: #2ecc71; font-weight: bold; }
        .action-btn { background: #2ecc71; border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: 0.2s; }
        .action-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        select, input[type="file"] { width: 100%; background: #000; color: white; border: 1px solid var(--primary-red); padding: 10px; margin-top: 5px; border-radius: 5px; cursor: pointer; }

        @media (max-width: 650px) { .login-right { clip-path: none; order: -1; min-height: 150px; padding: 20px; } }
        .search-container {
    margin-top: 15px;
    position: relative;
}

    .search-input {
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 0, 0, 0.3);
        color: white;
        padding: 12px 15px;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
        transition: 0.3s;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary-red);
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.4);
        background: rgba(255, 255, 255, 0.08);
    }

    .search-input::placeholder {
        color: #666;
    }
    .score-input {
    width: 60px;
    background: #000;
    color: #ff4d4d;
    border: 1px solid #333;
    text-align: center;
    border-radius: 4px;
    padding: 5px;
}
.score-input:focus {
    border-color: var(--primary-red);
    outline: none;
}
    </style>
    
</head>
<body>

    <div class="container">
        <div id="loginPage">
            <div class="login-left">
                <h2 style="text-align: center;">LOGIN</h2>
                <div class="inputbox"><input type="text" id="username" placeholder="Username"></div>
                <div class="inputbox"><input type="password" id="password" placeholder="Password"></div>
                <button class="btn-glow" onclick="checkLogin()">Enter</button>
            </div>
            <div class="login-right">
                <h1 style="margin: 0;">SMART</h1>
                <h2 style="margin: 0; letter-spacing: 3px;">ATTENDANCE</h2>
                <p>Mr. Moamen Mohamed</p>
            </div>
        </div>

        <div id="mainPage">
            <div class="header-nav">
                <span style="color: var(--primary-red); font-weight: bold;">smart attendance system</span>
                <button onclick="logoutAndReset()" style="background:none; border:1px solid red; color:white; cursor:pointer; padding:5px 10px; border-radius:5px;">Logout</button>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <label>Select Center:</label>
                    <select id="centerSelect" onchange="loadCenterData()">
                        <option value="Smart_Haram">Smart Haram</option>
                        <option value="Smart_October">Smart October</option>
                        <option value="Smart_Dokki">Smart Dokki</option>
                        <option value="Smart_Zayed">Smart Zayed</option>
                        <option value="Learn_Mohandseen">Learn Mohandseen</option>
                        <option value="A_One_Haram">A One Haram</option>
                        <option value="College_Nady">College Nady</option>
                        <option value="College_Horus">College Horus</option>
                    </select>
                </div>
                <div class="card">
                    <label>Academic Year:</label>
                    <select id="gradeSelect" onchange="loadCenterData()">
                        <option value="2nd_sec">2nd Secondary</option>
                        <option value="3rd_sec">3rd Secondary</option>
                    </select>
                </div>
                <div class="card">
                    <label>Import Excel:</label>
                    <input type="file" id="excelFile" accept=".xlsx, .xls">
                </div>
            </div>

            <div class="card" style="margin-top: 15px;">
                <div class="add-student-container">
                    <input type="text" id="newName" class="manual-input" placeholder="Enter student name manually">
                    <button onclick="addNewStudent()" class="btn-add">ADD STUDENT</button>
                </div>
            </div>
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="üîç Search by student name..." onkeyup="filterStudents()">
                </div>
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Student phone</th>
                            <th>parent phone</th>
                            <th>Status</th>
                            <th>Score</th>
                            
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="studentsBody"></tbody>
                </table>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px; padding-bottom: 20px; flex-wrap: wrap;">
                <button class="btn-glow" onclick="exportToExcel()" style="flex: 2; min-width: 200px;">Download Report (Excel) üì•</button>
              
                <button onclick="resetCenterData()" style="flex: 1; min-width: 100px; background:none; border:none; color:#555; cursor:pointer; font-size:12px;">Reset Data</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±ÿ®ÿ∑ ÿ®ÿßŸÑÿ≥ÿ≠ÿßÿ® (ÿ∂ÿπŸä ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ŸáŸÜÿß) ---
        const SUPABASE_URL = 'https://irjlgzgyifeqiolmkjwn.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_AUEngtqQkWx4LZXSPLYSmw_LVdpe4a0';
        
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentStudents = [];

        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
        async function checkLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(u === "assistant" && p === "assistant123") {
                document.getElementById('loginPage').style.display = "none";
                document.getElementById('mainPage').style.display = "flex";
                await loadCenterData();
            } else { alert("Access Denied!"); }
        }

        // ÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        async function loadCenterData() {
            const center = document.getElementById('centerSelect').value;
            const grade = document.getElementById('gradeSelect').value;
            
            const { data, error } = await _supabase
                .from('students')
                .select('*')
                .eq('center', center)
                .eq('grade', grade);

            if (!error) {
                currentStudents = data || [];
                renderTable();
            }
        }

        // ÿ±ÿ≥ŸÖ ÿßŸÑÿ¨ÿØŸàŸÑ
       function renderTable() {
    const body = document.getElementById('studentsBody');
    body.innerHTML = "";
    currentStudents.forEach((st) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${st.name}</td>
            <td>
                <input type="text" class="score-input" style="width:110px"
                    value="${st.student_phone || ''}" 
                    placeholder="01xxxx"
                    onchange="updateField('${st.id}', 'student_phone', this.value)">
            </td>
            <td>
                <input type="text" class="score-input" style="width:110px"
                    value="${st.parent_phone || ''}" 
                    placeholder="01xxxx"
                    onchange="updateField('${st.id}', 'parent_phone', this.value)">
            </td>
            <td class="${st.status === 'Present' ? 'status-present' : 'status-absent'}">${st.status}</td>
            <td>
                <input type="text" class="score-input" style="width:60px"
                    value="${st.score || ''}" 
                    placeholder="--"
                    onchange="updateField('${st.id}', 'score', this.value)">
            </td>
            <td>
                <button class="action-btn" onclick="markPresent('${st.id}')" 
                ${st.status === 'Present' ? 'disabled' : ''}>
                ${st.status === 'Present' ? 'Done' : 'Mark Present'}
                </button>
            </td>
        `;
        body.appendChild(tr);
    });
}

        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ÿ£ŸàŸÜŸÑÿßŸäŸÜ
        async function markPresent(id) {
            const { error } = await _supabase
                .from('students')
                .update({ status: 'Present' })
                .eq('id', id);

            if (!error) await loadCenterData();
        }

        // ÿ•ÿ∂ÿßŸÅÿ© ÿ∑ÿßŸÑÿ® ŸäÿØŸàŸä ÿ£ŸàŸÜŸÑÿßŸäŸÜ
        async function addNewStudent() {
            const name = document.getElementById('newName').value.trim();
            const center = document.getElementById('centerSelect').value;
            const grade = document.getElementById('gradeSelect').value;

            if (name) {
                const { error } = await _supabase.from('students').insert([
                    { name, center, grade, status: 'Absent' }
                ]);
                if (!error) {
                    document.getElementById('newName').value = "";
                    await loadCenterData();
                }
            }
        }

        // ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿ•ŸÉÿ≥ŸäŸÑ ŸÑŸÑÿ≥ÿ≠ÿßÿ®
        document.getElementById('excelFile').onchange = (e) => {
    const reader = new FileReader();
    reader.onload = async (ev) => {
        const data = new Uint8Array(ev.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        
        const center = document.getElementById('centerSelect').value;
        const grade = document.getElementById('gradeSelect').value;

        const newRows = json.map(r => {
    // ÿØÿßŸÑÿ© ÿµÿ∫Ÿäÿ±ÿ© ŸÑÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ±ŸÇŸÖ Ÿàÿ•ÿ∂ÿßŸÅÿ© ŸÉŸàÿØ ŸÖÿµÿ± 2
    const formatPhone = (phone) => {
        if (!phone) return "";
        let p = phone.toString().trim();
        // ŸÑŸà ÿßŸÑÿ±ŸÇŸÖ ÿ®Ÿäÿ®ÿØÿ£ ÿ®ŸÄ 0ÿå ÿ®ŸÜÿ¥ŸäŸÑ ÿßŸÑÿµŸÅÿ± ŸàŸÜÿ≠ÿ∑ 20
        if (p.startsWith('0')) {
            return '20' + p.substring(1);
        }
        // ŸÑŸà ÿßŸÑÿ±ŸÇŸÖ ŸÖÿ¥ ÿ®Ÿäÿ®ÿØÿ£ ÿ®ŸÄ 20ÿå ÿ®ŸÜÿ∂ŸäŸÅŸáÿß ŸÑŸá
        if (!p.startsWith('20') && p.length >= 10) {
            return '20' + p;
        }
        return p;
    };

    return {
        name: r["ÿßŸÑÿßÿ≥ŸÖ"] || r["Name"] || Object.values(r)[0],
        student_phone: formatPhone(r["ÿ±ŸÇŸÖ ÿßŸÑÿ∑ÿßŸÑÿ®"] || r["Student Phone"] || r["Mobile"]),
        parent_phone: formatPhone(r["ÿ±ŸÇŸÖ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±"] || r["Parent Phone"]),
        center: center,
        grade: grade,
        status: 'Absent',
        score: '0'
    };
}).filter(x => x.name);
        const { error } = await _supabase.from('students').insert(newRows);
        if (!error) {
            alert("ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠ ÿ¥ÿßŸÖŸÑÿ© ÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑÿ™ŸÑŸäŸÅŸàŸÜÿßÿ™!");
            await loadCenterData();
        } else {
            alert("ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ±ŸÅÿπ: " + error.message);
        }
    };
    reader.readAsArrayBuffer(e.target.files[0]);
};
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÜŸáÿßÿ¶Ÿä
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÜŸáÿßÿ¶Ÿä ÿ®ÿµŸäÿ∫ÿ© ÿ•ŸÉÿ≥ŸÑ ÿ¥ÿßŸÖŸÑ ÿßŸÑŸÄ Score
async function exportToExcel() {
    const tableRows = document.querySelectorAll('#studentsBody tr');
    if (tableRows.length === 0) return alert("No data to export!");

    const excelRows = [];

    tableRows.forEach(row => {
        // ÿ≥ÿ≠ÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ¨ÿØŸäÿØ ŸÑŸÑÿ£ÿπŸÖÿØÿ©
        const name = row.cells[0].innerText;
        // ÿ±ŸÇŸÖ ÿßŸÑÿ∑ÿßŸÑÿ® ŸÅŸä ÿßŸÑÿÆŸÑŸäÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ© (index 1)
        const studentPhone = row.cells[1].querySelector('input').value || "";
        // ÿ±ŸÇŸÖ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ± ŸÅŸä ÿßŸÑÿÆŸÑŸäÿ© ÿßŸÑÿ´ÿßŸÑÿ´ÿ© (index 2)
        const parentPhone = row.cells[2].querySelector('input').value || "";
        // ÿßŸÑÿ≠ÿßŸÑÿ© ŸÅŸä ÿßŸÑÿÆŸÑŸäÿ© ÿßŸÑÿ±ÿßÿ®ÿπÿ© (index 3)
        const status = row.cells[3].innerText;
        // ÿßŸÑÿØÿ±ÿ¨ÿ© ŸÅŸä ÿßŸÑÿÆŸÑŸäÿ© ÿßŸÑÿÆÿßŸÖÿ≥ÿ© (index 4)
        const score = row.cells[4].querySelector('input').value || "0";
        
        const center = document.getElementById('centerSelect').value;
        const grade = document.getElementById('gradeSelect').value;

        excelRows.push({
            "Student Name": name,
            "Student Phone": studentPhone,
            "Parent Phone": parentPhone,
            "Status": status,
            "Score": score,
            "Center": center,
            "Year": grade,
            "Date": new Date().toLocaleDateString()
        });
    });

    const ws = XLSX.utils.json_to_sheet(excelRows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Attendance");
    
    // ÿ™ÿ≥ŸÖŸäÿ© ÿßŸÑŸÖŸÑŸÅ ÿ®ÿßÿ≥ŸÖ ÿßŸÑÿ≥ŸÜÿ™ÿ± ŸàÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸÑÿ≥ŸáŸàŸÑÿ© ÿßŸÑÿ™ŸÜÿ∏ŸäŸÖ
    const fileName = `Report_${document.getElementById('centerSelect').value}_${new Date().toLocaleDateString()}.xlsx`;
    XLSX.writeFile(wb, fileName);
}

        // ŸÖÿ≥ÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ŸÜÿ™ÿ±
        async function resetCenterData() {
            if(confirm("Delete all students for this center from cloud?")) {
                const center = document.getElementById('centerSelect').value;
                const grade = document.getElementById('gradeSelect').value;
                await _supabase.from('students').delete().eq('center', center).eq('grade', grade);
                await loadCenterData();
            }
        }
        // ÿØÿßŸÑÿ© ŸÖÿ≥ÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ŸÜÿ™ÿ± ÿßŸÑŸÖÿÆÿ™ÿßÿ±
async function resetCenterData() {
    const center = document.getElementById('centerSelect').value;
    const grade = document.getElementById('gradeSelect').value;

    if (confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿ∑ŸÑÿßÿ® ÿ≥ŸÜÿ™ÿ± (${center})ÿü ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°.`)) {
        const { error } = await _supabase
            .from('students')
            .delete()
            .eq('center', center)
            .eq('grade', grade);

        if (error) {
            alert("ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÖÿ≥ÿ≠: " + error.message);
        } else {
            alert("ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ŸÜÿ™ÿ± ÿ®ŸÜÿ¨ÿßÿ≠");
            await loadCenterData(); // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ¨ÿØŸàŸÑ ŸÑŸäÿ∏Ÿáÿ± ŸÅÿßÿ±ÿ∫ÿßŸã
        }
    }
}
function filterStudents() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#studentsBody tr');

    rows.forEach(row => {
        const studentName = row.cells[0].textContent.toLowerCase();
        if (studentName.includes(searchTerm)) {
            row.style.display = ""; // ÿ•ÿ∏Ÿáÿßÿ±
        } else {
            row.style.display = "none"; // ÿ•ÿÆŸÅÿßÿ°
        }
    });
}
async function logoutAndReset() {
    const center = document.getElementById('centerSelect').value;
    const grade = document.getElementById('gradeSelect').value;

    if (confirm("ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ Ÿàÿ™ÿµŸÅŸäÿ± ŸÉÿ¥ŸÅ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸàÿßŸÑÿØÿ±ÿ¨ÿßÿ™ÿü")) {
        try {
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÑÿßÿ® ÿ•ŸÑŸâ Absent Ÿàÿ™ÿµŸÅŸäÿ± ÿßŸÑŸÄ Score ŸÅŸä Supabase
            const { error } = await _supabase
                .from('students')
                .update({ 
                    status: 'Absent', 
                    score: '' // ÿ£Ÿà '0' ÿ≠ÿ≥ÿ® ŸÖÿß ÿ™ŸÅÿ∂ŸÑŸäŸÜ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™ŸÉ
                })
                .eq('center', center)
                .eq('grade', grade);

            if (error) {
                console.error("Error resetting data:", error);
                alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿµŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™");
            } else {
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸàÿßŸÑÿ®ÿØÿ° ŸÖŸÜ ÿ¨ÿØŸäÿØ
                location.reload(); 
            }
        } catch (err) {
            console.error(err);
            location.reload();
        }
    }
}
async function updateScore(id, newScore) {
    const { error } = await _supabase
        .from('students')
        .update({ score: newScore }) // ÿ™ÿ£ŸÉÿØŸä ÿ£ŸÜ ÿßŸÑÿßÿ≥ŸÖ ŸáŸÜÿß Ÿäÿ∑ÿßÿ®ŸÇ ŸÖÿß ŸÅŸä Supabase ÿ™ŸÖÿßŸÖÿßŸã
        .eq('id', id);

    if (error) {
        console.log("Detailed Error:", error); // Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ∑ÿ± ÿ≥ŸäÿÆÿ®ÿ±ŸÜÿß ŸÅŸä ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÖÿß ÿßŸÑŸÖÿ¥ŸÉŸÑÿ© ÿ®ÿßŸÑÿ∂ÿ®ÿ∑
        alert("Error: " + error.message); // ÿ≥Ÿäÿ∏Ÿáÿ± ŸÑŸÉŸê ÿ≥ÿ®ÿ® ÿßŸÑÿÆÿ∑ÿ£ ÿßŸÑÿ≠ŸÇŸäŸÇŸä ŸÅŸä ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
    }
}

const excelRows = currentStudents.map(st => ({
    "Student Name": st.name,
    "Status": st.status,
    "Score": st.score || "N/A", // ÿ£ÿ∂ŸäŸÅŸä Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ∑ÿ±
    "Center": st.center,
    "Year": st.grade,
    "Date": new Date().toLocaleDateString()
}));
function sendWhatsApp(id) {
    const student = currentStudents.find(st => st.id === id);
    if (!student || !student.parent_phone) {
        alert("Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ÿ∂ÿßŸÅÿ© ÿ±ŸÇŸÖ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ± (Ÿäÿ®ÿØÿ£ ÿ®ŸÉŸàÿØ ÿßŸÑÿØŸàŸÑÿ© ŸÖÿ´ŸÑ 2010...)");
        return;
    }

    const name = student.name;
    const score = student.score || "ŸÑŸÖ Ÿäÿ™ŸÖ ÿ±ÿµÿØ ÿØÿ±ÿ¨ÿ©";
    const status = student.status === 'Present' ? "ÿ≠ÿ∂ÿ± ÿßŸÑŸäŸàŸÖ" : "ÿ∫ÿßÿ¶ÿ®";
    
    // ŸÜÿµ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
    const message = `ÿ™ÿ≠Ÿäÿ© ÿ∑Ÿäÿ®ÿ© ŸÖŸÜ ŸÖÿ≥ÿ™ÿ± ŸÖÿ§ŸÖŸÜ ŸÖÿ≠ŸÖÿØ..%0AŸÜÿ≠Ÿäÿ∑ŸÉŸÖ ÿπŸÑŸÖÿßŸã ÿ®ÿ£ŸÜ ÿßŸÑÿ∑ÿßŸÑÿ®: ${name}%0Aÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿ∂Ÿàÿ±: ${status}%0AÿßŸÑÿØÿ±ÿ¨ÿ©: ${score}`;
    
    // ŸÅÿ™ÿ≠ ÿ±ÿßÿ®ÿ∑ Ÿàÿßÿ™ÿ≥ÿßÿ®
    const whatsappUrl = `https://wa.me/${student.parent_phone}?text=${message}`;
    window.open(whatsappUrl, '_blank');
}

// ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ±ŸÇŸÖ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ± ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿßÿ®
async function updateParentPhone(id, phone) {
    const { error } = await _supabase
        .from('students')
        .update({ parent_phone: phone })
        .eq('id', id);
    
    if (error) alert("ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ±ŸÇŸÖ: " + error.message);
}
async function updateField(id, fieldName, newValue) {
    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ŸÅŸàÿ±ÿßŸã
    const student = currentStudents.find(s => s.id === id);
    if (student) student[fieldName] = newValue;

    // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    const updateData = {};
    updateData[fieldName] = newValue;

    const { error } = await _supabase
        .from('students')
        .update(updateData)
        .eq('id', id);

    if (error) {
        alert("Error updating " + fieldName + ": " + error.message);
    }
}
async function saveToHistory() {
    if (currentStudents.length === 0) return alert("ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑÿ≠ŸÅÿ∏Ÿáÿß!");

    if (confirm("ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ŸÅÿ∏ Ÿáÿ∞Ÿá ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÉŸÄ (ÿ≥ÿ¨ŸÑ ÿ£ÿ≥ÿ®ŸàÿπŸä) ŸÑŸáÿ∞ÿß ÿßŸÑÿ≥ŸÜÿ™ÿ±ÿü")) {
        // ÿ™ÿ≠ÿ∂Ÿäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ•ÿ±ÿ≥ÿßŸÑ ŸÑŸÑÿ¨ÿØŸàŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆŸä
        const historyData = currentStudents.map(st => ({
            student_name: st.name,
            status: st.status,
            score: st.score || "0",
            center: st.center,
            grade: st.grade,
            week_date: new Date().toISOString().split('T')[0] // ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸäŸàŸÖ ÿ®ÿµŸäÿ∫ÿ© YYYY-MM-DD
        }));

        const { error } = await _supabase.from('attendance_history').insert(historyData);

        if (!error) {
            alert("ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸä ÿ®ŸÜÿ¨ÿßÿ≠! ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿ±ÿ§Ÿäÿ™Ÿá ŸÅŸä ÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±.");
        } else {
            alert("ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ŸÅÿ∏: " + error.message);
        }
    }
}
    </script>
</body>
</html>
